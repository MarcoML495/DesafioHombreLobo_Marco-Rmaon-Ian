name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ PR Details
        run: |
          echo "ğŸ” Pull Request: #${{ github.event.pull_request.number }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ¯ Target: ${{ github.event.pull_request.base.ref }}"
          echo "ğŸ“ Title: ${{ github.event.pull_request.title }}"

  lint-backend:
    name: Lint Backend Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring

      - name: ğŸ”§ Install dependencies
        run: |
          cd back
          composer install --prefer-dist --no-interaction

      - name: ğŸ” PHP Code Sniffer
        run: |
          cd back
          ./vendor/bin/phpcs --standard=PSR12 app/
        continue-on-error: true

  lint-frontend:
    name: Lint Frontend Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: ğŸ”§ Install dependencies
        run: |
          cd front
          npm ci

      - name: ğŸ” TypeScript Check
        run: |
          cd front
          npx tsc --noEmit

  test-migrations:
    name: Test Database Migrations
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_database
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql

      - name: ğŸ”§ Install dependencies
        run: |
          cd back
          composer install --prefer-dist --no-interaction

      - name: ğŸ”‘ Setup environment
        run: |
          cd back
          cp .env.example .env || echo "APP_KEY=base64:test" > .env
          php artisan key:generate

      - name: ğŸ—„ï¸ Run migrations
        run: |
          cd back
          php artisan migrate --force
        env:
          DB_HOST: 127.0.0.1
          DB_DATABASE: test_database
          DB_USERNAME: root
          DB_PASSWORD: test_password

      - name: ğŸ”„ Test rollback
        run: |
          cd back
          php artisan migrate:rollback --force
        env:
          DB_HOST: 127.0.0.1
          DB_DATABASE: test_database
          DB_USERNAME: root
          DB_PASSWORD: test_password

  size-check:
    name: Build Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: ğŸ”§ Install dependencies
        run: |
          cd front
          npm ci

      - name: ğŸ—ï¸ Build
        run: |
          cd front
          npm run build

      - name: ğŸ“Š Check build size
        run: |
          cd front/dist
          echo "ğŸ“¦ Build size:"
          du -sh .
          echo ""
          echo "ğŸ“ Largest files:"
          find . -type f -exec du -h {} + | sort -rh | head -20

  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-frontend, test-migrations, size-check]
    if: always()
    
    steps:
      - name: ğŸ’¬ Post status comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Backend Lint': '${{ needs.lint-backend.result }}',
              'Frontend Lint': '${{ needs.lint-frontend.result }}',
              'Migrations': '${{ needs.test-migrations.result }}',
              'Build Size': '${{ needs.size-check.result }}'
            };
            
            let message = '## ğŸº Pull Request Check Results\n\n';
            for (const [name, result] of Object.entries(results)) {
              const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
              message += `${emoji} **${name}**: ${result}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });