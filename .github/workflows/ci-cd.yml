name: CI/CD Pipeline - Los Lobos de Castronegro

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ==========================================
  # BACKEND TESTS
  # ==========================================
  backend-tests:
    name: Backend Tests (Laravel)
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_database
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql, zip, gd, pcntl, sockets
          coverage: xdebug

      - name: ğŸ“¦ Copy .env
        run: |
          cd back
          cp .env.example .env || cp .env.testing .env || echo "APP_KEY=base64:test" > .env
          
      - name: ğŸ”§ Install Composer dependencies
        run: |
          cd back
          composer install --prefer-dist --no-interaction --no-progress

      - name: ğŸ”‘ Generate application key
        run: |
          cd back
          php artisan key:generate

      - name: ğŸ—„ï¸ Run migrations
        run: |
          cd back
          php artisan migrate --force
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test_database
          DB_USERNAME: root
          DB_PASSWORD: test_password

      - name: ğŸ§ª Run PHPUnit tests
        run: |
          cd back
          php artisan test --parallel
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test_database
          DB_USERNAME: root
          DB_PASSWORD: test_password

      - name: ğŸ“Š Generate code coverage
        run: |
          cd back
          php artisan test --coverage
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

  # ==========================================
  # CODE QUALITY CHECKS
  # ==========================================
  code-quality:
    name: Code Quality (Laravel)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, zip
          tools: phpstan, php-cs-fixer

      - name: ğŸ”§ Install dependencies
        run: |
          cd back
          composer install --prefer-dist --no-interaction

      - name: ğŸ” Run PHPStan (Static Analysis)
        run: |
          cd back
          ./vendor/bin/phpstan analyse --memory-limit=2G
        continue-on-error: true

      - name: ğŸ¨ Check code style (PHP CS Fixer)
        run: |
          cd back
          ./vendor/bin/php-cs-fixer fix --dry-run --diff
        continue-on-error: true

  # ==========================================
  # FRONTEND TESTS & BUILD
  # ==========================================
  frontend-build:
    name: Frontend Build & Tests (Vite)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: ğŸ”§ Install dependencies
        run: |
          cd front
          npm ci

      - name: ğŸ§¹ Lint TypeScript
        run: |
          cd front
          npx tsc --noEmit
        continue-on-error: true

      - name: ğŸ—ï¸ Build production
        run: |
          cd front
          npm run build

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-build
          path: front/dist/
          retention-days: 7

  # ==========================================
  # DOCKER BUILD TEST
  # ==========================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./back
          file: ./back/Dockerfile
          push: false
          tags: werewolf-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ—ï¸ Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./front
          file: ./front/Dockerfile
          push: false
          tags: werewolf-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # SECURITY SCAN
  # ==========================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Composer security checker
        run: |
          cd back
          composer audit
        continue-on-error: true

      - name: ğŸ”’ Run npm audit
        run: |
          cd front
          npm audit --audit-level=moderate
        continue-on-error: true

  # ==========================================
  # DEPLOYMENT (only on main branch)
  # ==========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-build, docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy notification
        run: |
          echo "ğŸ® Deploying Los Lobos de Castronegro to production..."
          echo "âœ… All tests passed!"
          
      # AquÃ­ puedes aÃ±adir pasos de deployment reales:
      # - Deploy a servidor
      # - Actualizar Docker containers
      # - Notificaciones a Slack/Discord
      
      - name: ğŸ“¢ Success notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸº Los Lobos estÃ¡n listos para cazar..."

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸŒ™ Los lobos tendrÃ¡n que esperar..."