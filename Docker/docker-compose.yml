services:
  back:
    build:
      context: ../back
      dockerfile: Dockerfile
    container_name: laravel_back
    working_dir: /var/www/html
    volumes:
      - ../back:/var/www/html
      - back_vendor:/var/www/html/vendor
    ports:
      - "8000:8000"  # Laravel
      - "8080:8080"  # Reverb WebSocket
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - app_net
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=ManadaFullHouse
      - DB_USERNAME=root
      - DB_PASSWORD=Miguel
    command: >
      sh -c "
        echo 'ðŸš€ Iniciando servicios Laravel...' &&
        until php artisan db:show 2>/dev/null; do
          echo 'â³ Esperando a MySQL...' &&
          sleep 2;
        done &&
        echo 'âœ… MySQL estÃ¡ listo' &&
        composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress &&
        php artisan key:generate --force &&
        php artisan migrate --force &&
        php artisan config:clear &&
        php artisan cache:clear &&
        php artisan view:clear &&
        echo 'ðŸ”Œ Iniciando Reverb WebSocket Server...' &&
        php artisan reverb:start --host=0.0.0.0 --port=8080 > /var/log/reverb.log 2>&1 &
        echo 'ðŸŒ Iniciando servidor Laravel...' &&
        php artisan serve --host=0.0.0.0 --port=8000
      "

  scheduler:
    build:
      context: ../back
      dockerfile: Dockerfile
    container_name: laravel_scheduler
    working_dir: /var/www/html
    volumes:
      - ../back:/var/www/html
      - back_vendor:/var/www/html/vendor
    depends_on:
      - back
      - mysql
    networks:
      - app_net
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=ManadaFullHouse
      - DB_USERNAME=root
      - DB_PASSWORD=Miguel
    command: >
      sh -c "
        echo 'â° Esperando a que Laravel estÃ© listo...' &&
        sleep 10 &&
        echo 'ðŸ• Iniciando Laravel Scheduler...' &&
        php artisan schedule:work
      "

  front:
    build:
      context: ../front
      dockerfile: Dockerfile
    container_name: vite_front
    working_dir: /app
    volumes:
      - ../front:/app
      - front_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    networks:
      - app_net
    environment:
      - NODE_ENV=development
    command: >
      sh -c "
        echo 'ðŸš€ Iniciando servicios Vite...' &&
        npm ci --prefer-offline --no-audit 2>/dev/null || echo 'ðŸ“¦ Dependencias ya instaladas' &&
        echo 'âš¡ Iniciando Vite dev server...' &&
        npm run dev -- --host 0.0.0.0 --port 5173
      "

  nginx:
    image: nginx:1.27
    container_name: nginx_laravel
    ports:
      - "80:80"
    volumes:
      - ../back:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - back
    networks:
      - app_net

  mysql:
    image: mysql:8.0
    container_name: mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: Miguel
      MYSQL_DATABASE: ManadaFullHouse
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pMiguel"]
      timeout: 5s
      retries: 10
      interval: 3s

networks:
  app_net:
    driver: bridge

volumes:
  mysql_data:
  back_vendor:
  front_node_modules: